<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Entry â€” Unsay</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand" href="app.html">Unsay</a>
        <div class="d-flex">
          <button id="entry-back" class="btn btn-link">Back</button>
        </div>
      </div>
    </nav>

    <main class="container py-4">
      <div class="card p-3">
        <input id="entry-title" class="form-control mb-2" placeholder="Title (optional)" />
        <div class="editor-toolbar mb-2 d-flex gap-2">
          <button id="bold-btn" class="btn btn-sm btn-outline-secondary"><strong>B</strong></button>
          <button id="italic-btn" class="btn btn-sm btn-outline-secondary"><em>I</em></button>
          <input id="mood" class="form-control form-control-sm" placeholder="mood tags (comma-separated)" style="max-width:240px" />
          <div class="ms-auto d-flex gap-2">
            <button id="save-btn" class="btn btn-outline-secondary btn-sm">Save Draft</button>
            <button id="publish-btn" class="btn btn-primary btn-sm">Publish</button>
          </div>
        </div>

        <div id="editor" contenteditable="true" class="editor form-control" style="min-height:50vh"></div>
      </div>
    </main>

    <script type="module">
      import { onAuthStateChangedListener } from './js/auth.js';
      import { getEntry } from './js/database.js';
      import { setCurrentContext, loadEntryToEditor, saveAsDraft, publishEntry, format, startAutosave } from './js/editor.js';

      let uid = null;
      function getQueryParam(name) {
        return new URLSearchParams(location.search).get(name);
      }

      onAuthStateChangedListener(async (user) => {
        if (!user) return location.href = 'index.html';
        uid = user.uid;
        setCurrentContext(uid, null);
        const entryId = getQueryParam('entryId');
        if (entryId) {
          const entry = await getEntry(uid, entryId);
          if (entry) setCurrentContext(uid, entry.id);
          loadEntryToEditor(entry || { title: '', content: '' });
        } else {
          loadEntryToEditor({ title: '', content: '' });
        }
        startAutosave();
      });

      document.getElementById('save-btn').addEventListener('click', async () => {
        try {
          await saveAsDraft();
          alert('Saved draft.');
        } catch (e) { alert(e.message || 'Save failed'); }
      });

      document.getElementById('publish-btn').addEventListener('click', async () => {
        const mood = document.getElementById('mood').value.split(',').map(s => s.trim()).filter(Boolean);
        try {
          await publishEntry(mood);
          alert('Published.');
          location.href = 'app.html';
        } catch (e) { alert(e.message || 'Publish failed'); }
      });

      document.getElementById('bold-btn').addEventListener('click', () => format('bold'));
      document.getElementById('italic-btn').addEventListener('click', () => format('italic'));
      document.getElementById('entry-back').addEventListener('click', () => location.href = 'app.html');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
