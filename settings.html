<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Settings ‚Äì The Journal Project</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/dark-mode.css" />
</head>
<body>
  <nav style="background: var(--card); border-bottom: 1px solid var(--border); padding: 1rem;">
    <div class="container" style="max-width: 1100px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
      <a href="app.html" style="text-decoration: none; color: var(--text-primary); font-size: 1.5rem; font-weight: 600;">üìî The Journal Project</a>
      <a href="app.html" style="padding: 0.5rem 1rem; background: transparent; border: 1px solid var(--border); color: var(--text-primary); border-radius: 6px; text-decoration: none;">‚Üê Back</a>
    </div>
  </nav>

  <main class="container" style="max-width: 700px; margin: 2rem auto; padding: 0 1rem;">
    <div style="background: var(--card); padding: 2.5rem; border-radius: 12px; border: 1px solid var(--border);">
      <h1 style="margin: 0 0 0.5rem 0; color: var(--text-primary); font-size: 2rem;">Settings</h1>
      <p style="color: var(--text-secondary); margin: 0 0 2rem 0;">Manage your account preferences</p>

      <form id="settings-form">
        <!-- Account Settings -->
        <div style="margin-bottom: 2rem;">
          <h3 style="color: var(--text-primary); margin: 0 0 1rem 0; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
            üë§ Account Settings
          </h3>
          
          <div class="input-group" style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 500;">Display Name</label>
            <input id="display-name" class="form-control" placeholder="Your name" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--hover); color: var(--text-primary);" />
          </div>

          <div class="input-group" style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 500;">Email</label>
            <input id="user-email" type="email" disabled style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--hover); color: var(--text-secondary); opacity: 0.7; cursor: not-allowed;" />
            <small style="color: var(--text-secondary); font-size: 0.85rem;">Email cannot be changed</small>
          </div>
        </div>

        <hr style="border: none; border-top: 1px solid var(--border); margin: 2rem 0;" />

        <!-- Appearance Settings -->
        <div style="margin-bottom: 2rem;">
          <h3 style="color: var(--text-primary); margin: 0 0 1rem 0; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
            üé® Appearance
          </h3>
          
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--hover); border-radius: 8px; border: 1px solid var(--border);">
            <div>
              <div style="color: var(--text-primary); font-weight: 500; margin-bottom: 0.25rem;">Dark Mode</div>
              <div style="color: var(--text-secondary); font-size: 0.85rem;">Use dark theme for better readability</div>
            </div>
            <label class="toggle-switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
              <input type="checkbox" id="dark-mode-checkbox" style="opacity: 0; width: 0; height: 0;">
              <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .4s; border-radius: 34px;"></span>
            </label>
          </div>
        </div>

        <hr style="border: none; border-top: 1px solid var(--border); margin: 2rem 0;" />

        <!-- Privacy Settings -->
        <div style="margin-bottom: 2rem;">
          <h3 style="color: var(--text-primary); margin: 0 0 1rem 0; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
            üîí Privacy & Data
          </h3>
          
          <div style="padding: 1rem; background: var(--hover); border-radius: 8px; border: 1px solid var(--border); margin-bottom: 1rem;">
            <div style="color: var(--text-primary); font-weight: 500; margin-bottom: 0.5rem;">Your Data is Private</div>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0;">All your journal entries are encrypted and only accessible by you. We never share your data with third parties.</p>
          </div>

          <button type="button" id="export-data-btn" style="width: 100%; padding: 0.875rem; background: transparent; border: 1px solid var(--border); color: var(--text-primary); border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s ease;">
            üì• Export All Data (JSON)
          </button>
        </div>

        <hr style="border: none; border-top: 1px solid var(--border); margin: 2rem 0;" />

        <!-- Danger Zone -->
        <div style="margin-bottom: 2rem;">
          <h3 style="color: #dc3545; margin: 0 0 1rem 0; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
            ‚ö†Ô∏è Danger Zone
          </h3>
          
          <div style="padding: 1rem; background: rgba(220, 53, 69, 0.1); border-radius: 8px; border: 1px solid rgba(220, 53, 69, 0.3);">
            <div style="color: #dc3545; font-weight: 500; margin-bottom: 0.5rem;">Delete Account</div>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0 0 1rem 0;">Permanently delete your account and all your journal entries. This action cannot be undone.</p>
            <button type="button" id="delete-account-btn" style="padding: 0.75rem 1.5rem; background: #dc3545; border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 500;">
              Delete My Account
            </button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
          <button type="submit" id="save-settings" style="flex: 1; padding: 1rem; background: var(--accent); border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem;">
            üíæ Save Changes
          </button>
          <a href="app.html" style="flex: 1; padding: 1rem; background: transparent; border: 1px solid var(--border); color: var(--text-primary); border-radius: 8px; text-decoration: none; text-align: center; font-weight: 500;">
            Cancel
          </a>
        </div>
      </form>
    </div>
  </main>

  <!-- Toast Container -->
  <div id="toast-container"></div>

  <style>
    /* Toggle Switch Styling */
    .toggle-switch input:checked + .slider {
      background-color: var(--accent);
    }

    .slider::before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider::before {
      transform: translateX(26px);
    }

    button:hover, .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    #export-data-btn:hover {
      background: var(--hover);
      border-color: var(--accent);
    }
  </style>

  <script type="module">
    import { onAuthStateChangedListener } from './js/auth.js';
    import { setUserSettings, getUserDoc } from './js/database.js';
    import { getEntries } from './js/database.js';
    import { updateProfile } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { auth } from './firebase-config.js';
    import { setDarkMode } from './js/theme.js';
    import { showToast } from './js/toast.js';
    import { showLoading, hideLoading, setButtonLoading } from './js/loading.js';

    let uid = null;
    const nameInput = document.getElementById('display-name');
    const emailInput = document.getElementById('user-email');
    const darkCheckbox = document.getElementById('dark-mode-checkbox');

    onAuthStateChangedListener(async (user) => {
      if (!user) return location.href = 'index.html';
      uid = user.uid;
      
      try {
        showLoading('Loading settings...');
        
        nameInput.value = user.displayName || '';
        emailInput.value = user.email || '';
        
        const doc = await getUserDoc(uid);
        const isDark = doc?.settings?.darkMode ?? false;
        darkCheckbox.checked = isDark;
        setDarkMode(isDark);
      } catch (error) {
        console.error('Error loading settings:', error);
        showToast('Failed to load settings', 'error');
      } finally {
        hideLoading();
      }
    });

    // Dark mode toggle
    darkCheckbox.addEventListener('change', () => {
      setDarkMode(darkCheckbox.checked);
    });

    // Save settings
    document.getElementById('save-settings').addEventListener('click', async (e) => {
      e.preventDefault();
      const btn = e.target;
      const name = nameInput.value.trim();
      const dark = darkCheckbox.checked;
      
      try {
        setButtonLoading(btn, true, 'Saving...');
        
        if (auth.currentUser && name) {
          await updateProfile(auth.currentUser, { displayName: name });
        }
        
        await setUserSettings(uid, { darkMode: dark });
        
        showToast('Settings saved successfully!', 'success');
        setTimeout(() => location.href = 'app.html', 1000);
      } catch (err) {
        console.error('Save error:', err);
        showToast('Failed to save settings', 'error');
      } finally {
        setButtonLoading(btn, false);
      }
    });

    // Export data
    document.getElementById('export-data-btn').addEventListener('click', async () => {
      try {
        showLoading('Exporting data...');
        
        const entries = await getEntries(uid);
        const userDoc = await getUserDoc(uid);
        
        const exportData = {
          user: {
            uid: uid,
            displayName: auth.currentUser?.displayName,
            email: auth.currentUser?.email,
            settings: userDoc?.settings
          },
          entries: entries.map(e => ({
            id: e.id,
            title: e.title,
            content: e.content,
            mood_tags: e.mood_tags,
            is_draft: e.is_draft,
            timestamp: e.timestamp?.toDate?.() || e.timestamp
          })),
          exportedAt: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `journal-export-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        showToast('Data exported successfully!', 'success');
      } catch (error) {
        console.error('Export error:', error);
        showToast('Failed to export data', 'error');
      } finally {
        hideLoading();
      }
    });

    // Delete account
    document.getElementById('delete-account-btn').addEventListener('click', () => {
      const confirmed = confirm(
        'Are you absolutely sure you want to delete your account?\n\n' +
        'This will permanently delete:\n' +
        '- Your account\n' +
        '- All your journal entries\n' +
        '- All your settings\n\n' +
        'This action CANNOT be undone!\n\n' +
        'Type "DELETE" to confirm.'
      );
      
      if (confirmed) {
        const verification = prompt('Type "DELETE" to confirm:');
        if (verification === 'DELETE') {
          showToast('Account deletion is not implemented yet. Contact support.', 'warning');
          // TODO: Implement account deletion
        }
      }
    });
  </script>
</body>
</html>